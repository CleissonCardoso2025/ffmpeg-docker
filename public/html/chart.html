<!DOCTYPE html>
<html>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script language="javascript" src="/public/chart.js/chart.js"></script>

    <script language="javascript" src="/public/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="/public/bootstrap/css/bootstrap.min.css" />

    <title>VMAF Chart</title>
    <body class="bg-light">
        <nav class="navbar bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <img
                        src="/public/images/favicon.ico"
                        alt="Logo"
                        width="30"
                        height="24"
                        class="d-inline-block align-text-top"
                    />
                    FFMPEG Docker
                </a>
            </div>
        </nav>

        <div class="container" style="margin-top: 80px">
            <canvas id="myChart" style="width: 80%"></canvas>
        </div>
        >
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            getData();

            async function getData() {
                const filename = urlParams.get("filename");
                const frames = [];
                const psnr = [];
                const ssim = [];
                const vmaf = [];

                const response = await fetch(`/api/vmaf/results/json?filename=${filename}`);
                const data = await response.json();

                const framesData = data.data.frames;
                for (let frame of framesData) {
                    frames.push(frame.frameNum);
                    psnr.push(frame.metrics.psnr);
                    ssim.push(frame.metrics.ssim);
                    vmaf.push(frame.metrics.vmaf);
                }

                new Chart("myChart", {
                    type: "line",
                    data: {
                        labels: frames,
                        datasets: [
                            {
                                label: "PSNR",
                                fill: false,
                                lineTension: 0,
                                backgroundColor: "rgba(0,0,255,0.6)",
                                borderColor: "rgba(0,0,255,0.6)",
                                pointRadius: 0,
                                data: psnr,
                            },
                            // {
                            //     label: "SSIM",
                            //     fill: false,
                            //     lineTension: 0,
                            //     backgroundColor: "rgba(0,255,0,0.6)",
                            //     borderColor: "rgba(0,255,0,0.6)",
                            //     pointRadius: 0,
                            //     data: ssim
                            // },
                            {
                                label: "VMAF",
                                fill: false,
                                lineTension: 0,
                                backgroundColor: "rgba(255,0,0,0.6)",
                                borderColor: "rgba(255,0,0,0.6)",
                                pointRadius: 0,
                                data: vmaf,
                            },
                        ],
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: "bottom",
                                display: true,
                            },
                            title: {
                                display: true,
                                text: `VMAF Results for ${filename}`,
                            },
                        },
                        responsive: true,
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: "Frames",
                                    padding: { top: 20, left: 0, right: 0, bottom: 0 },
                                },
                                ticks: {
                                    stepSize: 10,
                                },
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: "Percentage (0-100%)",
                                },
                                max: 100,
                                min: 0,
                                ticks: {
                                    stepSize: 2,
                                },
                                padding: { top: 20, left: 0, right: 0, bottom: 0 },
                            },
                        },
                    },
                });
            }
        </script>
    </body>
</html>
